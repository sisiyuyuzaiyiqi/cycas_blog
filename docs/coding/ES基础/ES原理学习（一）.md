## ES原理学习（一）

### 什么是ES

Elasticsearch是Elastic Stack核心的分布式搜索和分析引擎。

使用场景：

- 应用或网站中的搜索框功能
- 存储和分析日志，指标（metrics）和安全事件数据
- 使用机器学习实时自动建模数据行为
- 作为存储引擎自动化业务工作流程
- 作为地理信息系统（GIS）管理，集成和分析空间信息
- 作为生物信息学研究工具来存储和处理遗传数据

### 数据输入：文件（documents）和索引（indices）

Elasticsearch使用称为倒排索引（inverted index）的数据结构，该结构支持非常快速的全文本搜索。倒排索引列出了在任意文档中出现的唯一单词，并标识每个单词出现的所有文档。

索引（index）可以看作是文档的优化集合，每个文档都是字段的集合，这些字段是包含数据的键值对。Elasticsearch对每个字段中的所有数据建立索引，每个索引字段都有专用的优化数据结构。例如，文本字段存储在倒排索引中，数字字段和地理字段存储在BKD树中。

Elasticsearch还具有无模式的能力，这意味着可以在不显式指定如何处理文档中可能出现的每个不同字段的情况下对文档建立索引。启用动态映射（mapping）后，Elasticsearch会自动检测并将新字段添加到索引。ES默认会检测布尔值，浮点数和整数值，日期和字符串，并映射到适合的Elasticsearch数据类型。

也可以自己定义规则来控制动态映射，并显式定义映射以完全控制字段的存储和索引方式。

自定义映射可以：

- 区分全文字符串字段和精确值字符串字段
- 执行特定语言的文本分析
- 优化字段以进行局部匹配
- 使用自定义日期格式
- 使用不能被自动检测的数据类型，比如`geo_point`和`geo_shape`

由于不同的目的，时常会为同一字段建立不同的索引。例如，有可能希望将一个字符串字段索引为全文搜索的文本字段，同时有设置为索引关键字，以对数据进行排序或汇总。或者，可能选择使用多个语言分析器来处理用户输入的字符串字段。

在搜索时也会使用在索引期间应用于全文字段的分析链。查询全文字段时，对查询文本进行相同的分析，然后才能在索引中查找。

### 信息输出：检索和分析

虽然我们可以把ES当作一个文件存储库使用，检索文件及其元数据，但ES真正强大之处在于能够轻松访问基于Apache Lucene搜索引擎库构建的全套搜索功能。

ES提供了一个简单、一致的REST API，用于管理集群和索引，以及搜索数据。可以在命令行直接使用，以便于测试。也可以通过Kibana的开发者控制台。还可以通过ES client集成到自己的应用中，语言任选（Java，JavaScript，Go，.NET，PHP，Perl，Python 或者 Ruby）

#### 数据检索

Elasticsearch REST API支持结构化查询，全文查询和结合了两者的复杂查询。结构化查询类似于在SQL中构造的查询类型。比如，在`employee`索引中检索字段`gender`和`age`，并通过`hire_date`排序。全文查询检索所有匹配查询字符串的文件并按匹配程度返回。

除了单个词语检索外，还可以执行短语搜索、相似性搜索和前缀搜索，并获得自动完成建议。

地理空间或其他数字数据呢？ES通过在优化的数据结构中索引非文本数据，来支持高性能的地理和数字查询。

通过使用ES的JSON式查询语言（Query DSL），可以使用以上所有能力。也可以通过构造SQL式的查询在ES中搜索和聚合数据，借助JDBC和ODBC驱动使得大量第三方应用可以通过SQL和ES进行交互。

#### 分析数据

ES的聚合能力帮助构建数据的复杂摘要，深入了解关键指标、模式和趋势。通过该能力，在“大海捞针”之上，还可以解决：

- 海里有多少针？
- 所有针的平均长度是多少？
- 中间的针长度是多少，并由制造商细分后统计？
- 再过去的六个月，每个月有多少针加到海里？

聚合还可以回答更细微的问题：

- 最受欢迎的针制造商是谁？
- 有没有特殊或异常的针簇？

聚合利用了和搜索一样的数据结构，速度也会很快。因此可以实时分析和可视化数据。报告和仪表将随着数据的更新而变化，从而根据最新信息来采取措施。

此外，聚合和搜索请求是可以同步进行的。可以在单个请求中同时对相同数据搜索文档，过滤结果并执行分析。且由于聚合是根据特定搜索计算的，因此并非显示的所有70针，而是特指的70针，比如：所有尺寸的70个不粘绣针。

#### 更多

如何自动分析时间序列化的数据？可以使用机器学习功能在数据中创建正确行为的基准，识别异常模式，通过机器学习，可以检测：

- 在值、计数、频率方面与时间偏差有关的异常
- 统计稀有性
- 部分人口的异常行为

以上无需指定算法、模型或其他与数据科学相关的配置即可执行此操作。