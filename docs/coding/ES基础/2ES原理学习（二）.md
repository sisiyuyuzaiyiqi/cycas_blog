---
title: ES原理学习（二）
date: 2020-8-5 17:15
tags: [ES]

---

<CreateTime/>
<TagLinks />

## ES原理学习（二）

### 可伸缩性和弹性：集群，节点和分片

Elasticsearch旨在始终可用并根据需求扩展，它通过原生分布式来实现。可以将服务器（节点）添加到集群以增加容量，ES会自动在所有可用节点之间分配数据和查询负载。无需修改程序，ES知道如何平衡多节点集群来提供扩展性和高可用性。节点越多，效果越好。

这些是如何运作的？在后台，ES索引实际上只是一个或多个物理分片的逻辑分组，每个分片实际上是一个独立的索引。通过在多个分片中分配一个索引中的文件，在多个节点中分配这些分片，ES可以确保冗余以预防硬件故障，且随着节点被添加到集群中，查询容量也将增加。随着集群的增长（或收缩），ES会自动迁移分片以重新平衡集群。

分片有两种类型：主分片和副本分片。索引中的每个文档都属于一个主分片。副本分片是主分片的副本。它提供数据的冗余，以预防硬件故障并提高处理读写的能力，比如搜索和检索文档。

索引中的主分片数量在创建索引时是固定的。副本分片的数量可以随时更改，不会中断索引或查询操作。

#### 取决于...

一个索引的分片大小和主分片数量的设置有很多性能考虑和权衡取舍。分片越多，维护索引的开销越大。分片越大，ES重新平衡集群时移动分片的时间越长。

查询很多小的分片会使每个分片的处理速度更快，但是更多的查询意味着更多的开销，因此查询较小数量的大分片可能会更快。简而言之...要视情而定。

对初学者来说：

- 将平均分片大小保持在几GB到几十GB之间。对于具有基于时间的数据的用例，通常会看到20GB到40GB范围内的分片。
- 避免海量分片问题。节点可以容纳的分片数量与可用堆空间成比例。通常，每GB堆空间中的分片数量应少于20。

#### 以防万一

出于性能考虑，集群内的节点必须位于同一网络上。跨不同数据中心节点平衡集群内的分片会花费太长时间。但是高可用性架构要求避免把鸡蛋放在一个篮子里。若某处发生重大故障，别处的服务器应当能够无缝接管。怎么做？使用跨集群复制CCR（Cross-cluster replication）。

CCR提供了一种方法，可以自动将索引从主集群同步到可以用作热备份的辅助远程集群。如果主集群发生故障，则辅助集群可以接管。使用CCR还可以创建辅助集群，来根据地理位置为用户提供读请求服务。

跨集群复制是主动-被动模式。主集群上的索引是主动发布者索引，处理所有写请求。复制到辅助集群的索引是只读订阅者。

#### 维护

和其它企业系统一样，我们需要工具来保护、管理和监视ES集群。ES中集成了安全、监视和管理功能，可以使用Kibana作为控制中心来管理集群。